<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ControlPrice | Enterprise</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4f46e5; --success: #10b981; --danger: #ef4444; --bg: #f3f4f6; --white: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: #111827; overflow-x: hidden; }

        /* Notificações */
        #notif-container { position: fixed; top: 15px; right: 15px; z-index: 9999; width: 280px; }
        .toast { background: white; border-left: 5px solid var(--primary); padding: 12px; margin-bottom: 8px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); animation: slideIn 0.3s forwards; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* Header e Nav */
        header { background: white; padding: 10px 5%; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1000; }
        .nav-right { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); cursor: pointer; }

        /* Layout */
        main { padding: 20px 5%; max-width: 1200px; margin: 0 auto; }
        .view { display: none; }
        .view.active { display: block; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .grid-2 { display: flex; flex-direction: column; }
            header { padding: 10px 15px; }
            .logo { font-size: 1.1rem; }
        }

        /* Metas Kiwify Style */
        .goal-item { display: flex; align-items: center; gap: 15px; padding: 15px; border: 1px solid #eee; border-radius: 12px; margin-bottom: 10px; }
        .goal-img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; }
        .counter-val { font-size: 1.4rem; font-weight: 800; color: var(--success); }

        /* Chat DM */
        #chat-widget { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
        #chat-window { width: 320px; height: 450px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; flex-direction: column; overflow: hidden; }
        #chat-window.active { display: flex; }
        .chat-header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; }
        .chat-msgs { flex: 1; padding: 10px; overflow-y: auto; background: #f9f9f9; }
        .msg { margin-bottom: 8px; padding: 8px 12px; border-radius: 10px; max-width: 80%; }
        .msg.me { background: var(--primary); color: white; margin-left: auto; }
        .msg.other { background: #eee; }

        /* Dropdown */
        .dropdown { position: absolute; top: 50px; right: 5%; background: white; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); width: 200px; display: none; overflow: hidden; }
        .dropdown.active { display: block; }
        .dropdown div { padding: 12px; cursor: pointer; font-size: 0.9rem; }
        .dropdown div:hover { background: #f5f5f5; }

        /* Admin Tag */
        .admin-tag { background: #000; color: gold; padding: 2px 8px; border-radius: 5px; font-size: 0.7rem; font-weight: bold; }
        
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; outline: none; }
        .btn { border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
    </style>
</head>
<body>

    <div id="notif-container"></div>

    <div id="auth-screen" style="position:fixed; inset:0; background:var(--bg); z-index:5000; display:flex; align-items:center; justify-content:center; padding:20px">
        <div class="card" style="width:100%; max-width:400px; text-align:center">
            <h2 style="color:var(--primary); margin-bottom:20px">ControlPrice</h2>
            <div id="reg-fields">
                <input type="text" id="in-name" placeholder="Nome Completo">
            </div>
            <input type="text" id="in-user" placeholder="Usuário">
            <input type="password" id="in-pass" placeholder="Senha">
            <button class="btn btn-primary" onclick="handleAuth()" id="btn-auth">Cadastrar</button>
            <p onclick="toggleAuth()" style="margin-top:15px; font-size:0.8rem; cursor:pointer">Trocar para Login/Cadastro</p>
        </div>
    </div>

    <header>
        <div class="logo" style="font-weight:800" onclick="showView('home')">CONTROL<span>PRICE</span></div>
        <div class="nav-right">
            <span id="nav-user-name" style="font-weight:600; font-size:0.9rem"></span>
            <img id="nav-avatar" class="user-avatar" onclick="document.getElementById('dd').classList.toggle('active')">
        </div>
        <div class="dropdown" id="dd">
            <div onclick="showView('profile')"><i class="fas fa-user"></i> Ver Perfil</div>
            <div onclick="showView('friends')"><i class="fas fa-users"></i> Amigos</div>
            <div onclick="showView('config')"><i class="fas fa-cog"></i> Configurações</div>
            <div id="admin-btn" style="display:none; color:gold; background:#000" onclick="showView('admin')"><i class="fas fa-crown"></i> Painel Admin</div>
            <div onclick="logout()" style="color:var(--danger)"><i class="fas fa-sign-out-alt"></i> Sair</div>
        </div>
    </header>

    <main>
        <div id="view-home" class="view active">
            <div class="card" style="background:var(--primary); color:white">
                <p>Seu Saldo Total em Metas</p>
                <h1 id="total-balance" class="counter-val" style="color:white">R$ 0,00</h1>
            </div>

            <div class="card">
                <h3><i class="fas fa-plus"></i> Nova Meta Colaborativa</h3>
                <input type="text" id="m-name" placeholder="Nome da Meta">
                <input type="text" id="m-desc" placeholder="Descrição Curta">
                <input type="number" id="m-target" placeholder="Valor Alvo (R$)">
                <input type="text" id="m-img" placeholder="URL da Foto da Meta">
                <input type="text" id="m-friend" placeholder="Adicionar Amigo (username)">
                <button class="btn btn-primary" onclick="createGoal()">Criar Meta</button>
            </div>

            <div id="goals-list"></div>
        </div>

        <div id="view-profile" class="view">
            <div class="card" style="padding:0; overflow:hidden">
                <div id="p-banner" style="height:120px; background:var(--primary); position:relative; cursor:pointer" onclick="updateField('banner')">
                    <img id="p-banner-img" style="width:100%; height:100%; object-fit:cover">
                </div>
                <div style="text-align:center; margin-top:-40px; padding:20px">
                    <img id="p-avatar" style="width:80px; height:80px; border-radius:50%; border:4px solid white; background:white; cursor:pointer" onclick="updateField('avatar')">
                    <h2 id="p-name-disp">Nome</h2>
                    <p id="p-user-disp" style="color:gray">@user</p>
                    <div id="p-admin-tag"></div>
                    <textarea id="p-bio" placeholder="Sua Bio" style="margin-top:15px"></textarea>
                    <button class="btn btn-primary" onclick="saveBio()">Salvar Bio</button>
                </div>
            </div>
        </div>

        <div id="view-friends" class="view">
            <div class="card">
                <h3>Buscar Amigos</h3>
                <input type="text" id="f-search" placeholder="Username do amigo">
                <button class="btn btn-primary" onclick="sendReq()">Enviar Pedido</button>
            </div>
            <div class="card">
                <h3>Pedidos Pendentes</h3>
                <div id="f-reqs"></div>
            </div>
        </div>

        <div id="view-config" class="view">
            <div class="card">
                <h3>Segurança</h3>
                <input type="password" id="new-pass" placeholder="Nova Senha">
                <button class="btn btn-primary" onclick="changePass()">Alterar Senha</button>
            </div>
            <div class="card">
                <h3>Links Úteis</h3>
                <button class="btn" style="background:#eee; margin-bottom:5px" onclick="window.open('https://linktr.ee/silva777only')">Linktree Silva</button>
                <button class="btn" style="background:#eee; margin-bottom:5px" onclick="window.open('https://portfoliosilva.github.io/portfoliosilva/')">Portfolio Silva</button>
                <button class="btn" style="background:#eee" onclick="window.open('https://wikiclarastack.github.io/wikiclarastack/')">Wiki Clara Stack</button>
            </div>
        </div>

        <div id="view-admin" class="view">
            <div class="card">
                <h2>Gerenciamento de Usuários</h2>
                <div id="admin-user-list"></div>
            </div>
        </div>
    </main>

    <div id="chat-widget">
        <div id="chat-window">
            <div class="chat-header">
                <span id="chat-with">Chat</span>
                <i class="fas fa-times" onclick="toggleChat()"></i>
            </div>
            <div class="chat-msgs" id="chat-body"></div>
            <div style="display:flex; padding:10px; border-top:1px solid #eee">
                <input type="text" id="chat-input" placeholder="Mensagem..." style="margin:0; flex:1">
                <button onclick="sendMsg()" style="background:var(--primary); color:white; border:none; padding:10px; border-radius:10px; margin-left:5px">></button>
            </div>
        </div>
        <button id="chat-open-btn" onclick="toggleChat()" style="width:60px; height:60px; border-radius:50%; background:var(--primary); color:white; border:none; box-shadow:0 5px 15px rgba(0,0,0,0.3); font-size:1.5rem">
            <i class="fas fa-comments"></i>
        </button>
    </div>

    <script>
        let me = null;
        let authMode = 'reg';
        let chatTarget = null;

        function notify(m) {
            const t = document.createElement('div'); t.className = 'toast'; t.innerText = m;
            document.getElementById('notif-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // --- AUTH ---
        function toggleAuth() {
            authMode = authMode === 'reg' ? 'log' : 'reg';
            document.getElementById('reg-fields').style.display = authMode === 'reg' ? 'block' : 'none';
            document.getElementById('btn-auth').innerText = authMode === 'reg' ? 'Cadastrar' : 'Entrar';
        }

        function handleAuth() {
            const u = document.getElementById('in-user').value.toLowerCase();
            const p = document.getElementById('in-pass').value;
            let users = JSON.parse(localStorage.getItem('cp_users_v3')) || [];

            if(authMode === 'reg') {
                if(users.find(x => x.user === u)) return notify("Usuário já existe!");
                const n = { user: u, pass: p, name: document.getElementById('in-name').value, bio:'', avatar:'https://cdn-icons-png.flaticon.com/512/149/149071.png', banner:'', goals:[], friends:[], requests:[] };
                users.push(n);
                localStorage.setItem('cp_users_v3', JSON.stringify(users));
                notify("Cadastrado!"); toggleAuth();
            } else {
                const f = users.find(x => x.user === u && x.pass === p);
                if(f) { me = f; localStorage.setItem('cp_sess', u); init(); } else notify("Erro!");
            }
        }

        // --- CORE ---
        function init() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('nav-user-name').innerText = me.user;
            document.getElementById('nav-avatar').src = me.avatar;
            document.getElementById('p-name-disp').innerText = me.name;
            document.getElementById('p-user-disp').innerText = '@'+me.user;
            document.getElementById('p-avatar').src = me.avatar;
            document.getElementById('p-banner-img').src = me.banner || 'https://images.unsplash.com/photo-1557683316-973673baf926?w=500';
            document.getElementById('p-bio').value = me.bio;

            if(me.user === 'silva777') {
                document.getElementById('admin-btn').style.display = 'block';
                document.getElementById('p-admin-tag').innerHTML = '<span class="admin-tag">ADMINISTRADOR</span>';
            }

            renderGoals();
            renderRequests();
            renderAdmin();
        }

        function showView(v) {
            document.querySelectorAll('.view').forEach(x => x.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.getElementById('dd').classList.remove('active');
        }

        // --- METAS KIWIFY STYLE ---
        function createGoal() {
            const name = document.getElementById('m-name').value;
            const target = parseFloat(document.getElementById('m-target').value);
            const friend = document.getElementById('m-friend').value.toLowerCase();
            const img = document.getElementById('m-img').value || 'https://cdn-icons-png.flaticon.com/512/1611/1611154.png';

            if(!name || !target) return notify("Preencha Nome e Valor!");
            const g = { id: Date.now(), owner: me.user, name, desc: document.getElementById('m-desc').value, target, current: 0, img, collab: friend };
            me.goals.push(g);
            update(); renderGoals(); notify("Meta Criada!");
        }

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            if(!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const currentVal = (progress * (end - start) + start).toFixed(2);
                obj.innerText = "R$ " + parseFloat(currentVal).toLocaleString('pt-BR');
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function renderGoals() {
            const list = document.getElementById('goals-list');
            const users = JSON.parse(localStorage.getItem('cp_users_v3'));
            
            // Pega metas minhas + metas que sou collab
            let allVisible = [];
            users.forEach(u => {
                u.goals.forEach(g => {
                    if(g.owner === me.user || g.collab === me.user) allVisible.push(g);
                });
            });

            list.innerHTML = allVisible.map(g => `
                <div class="card goal-item">
                    <img src="${g.img}" class="goal-img">
                    <div style="flex:1">
                        <b>${g.name}</b> <small>(${g.owner === me.user ? 'Dono' : 'Colaborador'})</small>
                        <div id="anim-${g.id}" class="counter-val">R$ 0,00</div>
                        <p style="font-size:0.7rem; color:gray">Alvo: R$ ${g.target}</p>
                        ${g.owner === me.user ? `<button onclick="addVal(${g.id})" style="padding:5px; margin-top:5px" class="btn btn-primary">Adicionar R$</button>` : ''}
                    </div>
                </div>
            `).join('');

            allVisible.forEach(g => animateValue(`anim-${g.id}`, 0, g.current, 1000));
            const total = allVisible.reduce((a, b) => a + b.current, 0);
            animateValue('total-balance', 0, total, 1500);
        }

        function addVal(id) {
            const v = parseFloat(prompt("Valor a adicionar:"));
            if(!v) return;
            const g = me.goals.find(x => x.id === id);
            g.current += v;
            update(); renderGoals();
        }

        // --- CHAT DM ---
        function toggleChat() {
            const win = document.getElementById('chat-window');
            win.classList.toggle('active');
            if(win.classList.contains('active')) {
                const target = prompt("Com qual amigo deseja falar? (username)");
                if(me.friends.includes(target)) {
                    chatTarget = target;
                    document.getElementById('chat-with').innerText = "DM: " + target;
                    renderMsgs();
                } else {
                    notify("Você só pode falar com amigos!");
                    win.classList.remove('active');
                }
            }
        }

        function sendMsg() {
            const text = document.getElementById('chat-input').value;
            if(!text) return;
            let db = JSON.parse(localStorage.getItem('cp_msgs')) || [];
            db.push({ from: me.user, to: chatTarget, msg: text, time: Date.now() });
            localStorage.setItem('cp_msgs', JSON.stringify(db));
            document.getElementById('chat-input').value = '';
            renderMsgs();
        }

        function renderMsgs() {
            const db = JSON.parse(localStorage.getItem('cp_msgs')) || [];
            const filtered = db.filter(x => (x.from === me.user && x.to === chatTarget) || (x.from === chatTarget && x.to === me.user));
            document.getElementById('chat-body').innerHTML = filtered.map(x => `
                <div class="msg ${x.from === me.user ? 'me' : 'other'}">${x.msg}</div>
            `).join('');
            document.getElementById('chat-body').scrollTop = 9999;
        }

        // --- SISTEMA AMIGOS ---
        function sendReq() {
            const u = document.getElementById('f-search').value.toLowerCase();
            let users = JSON.parse(localStorage.getItem('cp_users_v3'));
            let f = users.find(x => x.user === u);
            if(!f) return notify("Não existe!");
            f.requests.push(me.user);
            localStorage.setItem('cp_users_v3', JSON.stringify(users));
            notify("Pedido enviado!");
        }

        function renderRequests() {
            document.getElementById('f-reqs').innerHTML = me.requests.map(r => `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px">
                    <span>${r}</span>
                    <button class="btn-primary" style="padding:5px 10px; border-radius:5px" onclick="accept('${r}')">Aceitar</button>
                </div>
            `).join('');
        }

        function accept(u) {
            me.friends.push(u);
            me.requests = me.requests.filter(x => x !== u);
            update(); renderRequests(); notify("Amigo aceito!");
        }

        // --- CONFIG ---
        function changePass() {
            const p = document.getElementById('new-pass').value;
            if(p.length < 4) return notify("Senha curta!");
            me.pass = p; update(); notify("Senha alterada!");
        }

        function saveBio() {
            me.bio = document.getElementById('p-bio').value;
            update(); notify("Bio salva!");
        }

        function updateField(type) {
            const val = prompt("Cole a URL da imagem:");
            if(!val) return;
            if(type === 'avatar') me.avatar = val;
            if(type === 'banner') me.banner = val;
            update(); init();
        }

        function update() {
            let users = JSON.parse(localStorage.getItem('cp_users_v3'));
            const i = users.findIndex(x => x.user === me.user);
            users[i] = me;
            localStorage.setItem('cp_users_v3', JSON.stringify(users));
        }

        function renderAdmin() {
            if(me.user !== 'silva777') return;
            let users = JSON.parse(localStorage.getItem('cp_users_v3'));
            document.getElementById('admin-user-list').innerHTML = users.map(u => `
                <div style="padding:10px; border-bottom:1px solid #eee">
                    <b>${u.user}</b> - ${u.name} 
                    <button onclick="deleteUser('${u.user}')" style="color:red; background:none; border:none; cursor:pointer">Remover</button>
                </div>
            `).join('');
        }

        function deleteUser(u) {
            if(u === 'silva777') return;
            let users = JSON.parse(localStorage.getItem('cp_users_v3')).filter(x => x.user !== u);
            localStorage.setItem('cp_users_v3', JSON.stringify(users));
            renderAdmin();
        }

        function logout() { localStorage.removeItem('cp_sess'); location.reload(); }

        // Auto Login
        const sess = localStorage.getItem('cp_sess');
        if(sess) {
            let users = JSON.parse(localStorage.getItem('cp_users_v3'));
            me = users.find(x => x.user === sess);
            if(me) init();
        }
    </script>
</body>
</html>
